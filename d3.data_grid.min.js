((function(){var a,b,c;b=typeof exports!="undefined"&&exports!==null?exports:this,a=(c=b.data_grid)!=null?c:b.data_grid={},a.version="0.1.0";var d={};d.ui={},d.ui.filter={},d.ui.filter.SearchEngine=function(){this.precedences_={or:1,and:2,not:3}},d.ui.filter.SearchEngine.prototype.doesTextMatchTokens=function(a,b,c){if(!b)return!0;a=c?a:a.toLowerCase();var d=[],e,f;for(var g=0;g<b.length;g++){var h=b[g];h!=="and"&&h!=="or"&&h!=="not"?h.indexOf(">")===0||h.indexOf("<")===0||h.indexOf("=")===0||h.indexOf("!=")===0?d.push(this.doesNumberMatchToken(h,a)):d.push(c?a===h:a.indexOf(h)>=0):h==="and"?(e=d.pop(),f=d.pop(),d.push(e&&f)):h==="or"?(e=d.pop(),f=d.pop(),d.push(e||f)):h==="not"&&(e=d.pop(),d.push(!e))}return d.length===1&&d.pop()},d.ui.filter.SearchEngine.prototype.parseSearchTokens=function(a){if(!a)return null;a=a.toLowerCase();var b=this.normaliseExpression(a);b=this.allowFriendlySearchTerms(b);var c=this.convertExpressionToPostFix(b),d=c.split("|");return d},d.ui.filter.SearchEngine.prototype.doesNumberMatchToken=function(a,b){var c,d,e=this.getNumberFrom(b);if(a.indexOf("=")===0)c="=",d=parseFloat(a.substring(1));else if(a.indexOf("!=")===0)c="!=",d=parseFloat(a.substring(2));else if(a.indexOf(">=")===0)c=">=",d=parseFloat(a.substring(2));else if(a.indexOf(">")===0)c=">",d=parseFloat(a.substring(1));else if(a.indexOf("<=")===0)c="<=",d=parseFloat(a.substring(2));else if(a.indexOf("<")===0)c="<",d=parseFloat(a.substring(1));else return!0;switch(c){case"!=":return e!==d;case"=":return e===d;case">=":return e>=d;case">":return e>d;case"<=":return e<=d;case"<":return e<d}throw new Error("Could not find a number operation: "+c)},d.ui.filter.SearchEngine.prototype.getNumberFrom=function(a){return a.charAt(0)==="$"&&(a=a.substring(1)),parseFloat(a)},d.ui.filter.SearchEngine.prototype.normaliseExpression=function(a){var b=this.getTokensFromExpression(a),c=[];for(var d=0;d<b.length;d++){var e=b[d];e=this.normaliseTerm(c,e,"("),e=this.normaliseTerm(c,e,")"),e.length>0&&c.push(e)}return c},d.ui.filter.SearchEngine.prototype.normaliseTerm=function(a,b,c){var d=b.indexOf(c);while(d!==-1)d>0&&a.push(b.substring(0,d)),a.push(c),b=b.substring(d+1),d=b.indexOf(c);return b},d.ui.filter.SearchEngine.prototype.getTokensFromExpression=function(a){a=a.replace(">= ",">=").replace("> ",">").replace("<= ","<=").replace("< ","<").replace("!= ","!=").replace("= ","=");var b=/([^"^\s]+)\s*|"([^"]+)"\s*/g,c=[],d=null;while(d=b.exec(a))c.push(d[1]||d[2]);return c},d.ui.filter.SearchEngine.prototype.allowFriendlySearchTerms=function(a){var b=[],c;for(var d=0;d<a.length;d++){var e=a[d];if(!e||e.length===0)continue;e.indexOf("-")===0&&(e="not",a[d]=a[d].substring(1),d--),c?(c!=="("&&c!=="not"&&c!=="and"&&c!=="or"&&e!=="and"&&e!=="or"&&e!==")"&&b.push("and"),b.push(e)):b.push(e),c=e}return b},d.ui.filter.SearchEngine.prototype.convertExpressionToPostFix=function(a){var b="",c=[],d;for(var e=0;e<a.length;e++){var f=a[e];if(f.length===0)continue;if(f!=="and"&&f!=="or"&&f!=="not"&&f!=="("&&f!==")")b=b+"|"+f;else if(c.length===0||f==="(")c.push(f);else if(f===")"){d=c.pop();while(d!=="("&&c.length>0)b=b+"|"+d,d=c.pop()}else if(c[c.length-1]==="(")c.push(f);else{while(c.length!==0){if(c[c.length-1]==="(")break;if(this.precedences_[c[c.length-1]]>this.precedences_[f])d=c.pop(),b=b+"|"+d;else break}c.push(f)}}while(c.length>0)b=b+"|"+c.pop();return b.substring(1)},d.ui.filter.FilterState=function(a,b,c,d){this.id=a,this.value=b,this.idx=c,this.type=d},d.ui.filter.FilterState.prototype.toString=function(){return"id["+this.id+"] value["+this.value+"] idx["+this.idx+"] type["+this.type+"]"};var e,f=function(a,b){return function(){return a.apply(b,arguments)}};e=function(){function a(){this.end_refresh_timer=f(this.end_refresh_timer,this),this.start_refresh_timer=f(this.start_refresh_timer,this),this.refresh=f(this.refresh,this),this.show=f(this.show,this),this.header=f(this.header,this),this.limit=f(this.limit,this),this.filter=f(this.filter,this),this.filter_states=f(this.filter_states,this),this.filter_state_for=f(this.filter_state_for,this),this.sort_decending=f(this.sort_decending,this),this.sort=f(this.sort,this),this.create_view_pagination=f(this.create_view_pagination,this),this.refresh_view=f(this.refresh_view,this),this.create_view=f(this.create_view,this),this.change_column_display=f(this.change_column_display,this),this.column_display_icon=f(this.column_display_icon,this),this.set_column_display=f(this.set_column_display,this),this.column_display=f(this.column_display,this),this.get_options=f(this.get_options,this),this.init_options=f(this.init_options,this),this.filters=[],this.search=new d.ui.filter.SearchEngine,this.timer=null,this.column_displays={}}return a.prototype.init_options=function(){var a;return a={},a.filename=getURLParameter("file")||null,a.page=parseInt(getURLParameter("page"))||1,a.limit=parseInt(getURLParameter("limit"))||100,a.sort=getURLParameter("sort")||null,a.page_top=getURLParameter("page_top")==="true",a.page_bottom=getURLParameter("page_bottom")!=="false",a.timer_interval=getURLParameter("timer_interval")||800,a.chart_display=getURLParameter("chart_display")!=="false",a},a.prototype.get_options=function(){return this.options||(this.options=this.init_options()),this.options},a.prototype.column_display=function(a){return this.column_displays[a]},a.prototype.set_column_display=function(a,b){return this.column_displays[a]=b},a.prototype.column_display_icon=function(a){return a==="num"?"/imgs/data_grid/eye.png":"/imgs/data_grid/chart.png"},a.prototype.change_column_display=function(a){var b,c,d,e,f;return c=this.column_display(a),e=c==="num"?"chart":"num",d=this.grid_body.selectAll("tr"),b=d3.extent(this.filtered_data,function(b){return parseFloat(d3.values(b)[a])}),f=d3.scale.linear().domain(b).range(["2px","30px"]),d.each(function(b){var d,e,g;return e=d3.values(b)[a],d=e,c==="num"&&(g=parseFloat(d3.values(b)[a]),g&&(d='<div title="'+e+'"class="data_grid_bar" style="width:'+f(g)+';background-color:steelBlue;height:16px;"></div>')),d3.select(this).selectAll("td").filter(function(b,c){return c===a}).html(d)}),this.set_column_display(a,e),this.display_controls.filter(function(b,c){return c===a}).attr("src",this.column_display_icon(c))},a.prototype.create_view=function(a,b,c){var d,e,f,g,h,i,j=this;return d=d3.select(a).append("table").attr("id","data_grid_table"),i=this.header(b),f=d.append("thead"),g=f.append("tr"),h=null,this.get_options().chart_display&&(h=f.append("tr").attr("class","grid_views")),e=f.append("tr").attr("class","filters"),g.selectAll("th").data(i).enter().append("th").attr("class",function(a){return"sortable"}).on("click",function(a,b){return j.sort_decending(b)}).text(function(a){return a}),h&&(this.display_controls=h.selectAll("td").data(i).enter().append("td").attr("class","data_grid_display_select").append("a").attr("href","#").on("click",function(a,b){return j.change_column_display(b)}).append("img").attr("src",this.column_display_icon("chart")),this.display_controls.each(function(a,b){return j.set_column_display(b,"num")})),this.filters=e.selectAll("td").data(i).enter().append("td").append("input").attr("id",function(a,b){return"filter_"+b}).attr("type","text").style("width","95%").on("input",function(a){return j.start_refresh_timer()}),this.grid_body=d.append("tbody")},a.prototype.refresh_view=function(a,b){var c,d,e,f,g,h,i;f=this.header(a),this.grid_body.selectAll("tr").remove(),d=this.grid_body.selectAll("tr").data(a),c=d.enter().append("tr"),i=[];for(g=0,h=f.length;g<h;g++)e=f[g],i.push(c.append("td").text(function(a){return a[e]}));return i},a.prototype.create_view_pagination=function(a,b,c){var d,e,f,g,h,i,j,k,l=this;return g=20,d=c.page,f=1,e=b.length===0?1:Math.ceil(b.length/c.limit),i=d3.select(a).attr("class","data_grid_page_links"),h=i.selectAll("a").remove(),h=i.selectAll("a").data(function(){k=[];for(var a=f;f<=e?a<=e:a>=e;f<=e?a++:a--)k.push(a);return k}.apply(this)),h.enter().append("a").attr("id",function(a){return"data_grid_page_link_"+a}).attr("data-page",function(a){return a}).attr("href","#").attr("class",function(a){return a===d?"data_grid_page_link current":"data_grid_page_link"}).text(function(a){return""+a}).on("click",function(a){return l.options.page=a,l.refresh()}),h.exit().remove()},a.prototype.sort=function(a,b){if(!b.sort)return;return a},a.prototype.sort_decending=function(a){return console.log("sort descending")},a.prototype.filter_state_for=function(a,b){var c,e;return c=a.type,e=a.value,e?new d.ui.filter.FilterState(a.getAttribute("id"),e,b,c):null},a.prototype.filter_states=function(){var b,c;return c=[],b=0,this.filters.each(function(d){var e;return e=a.prototype.filter_state_for(this,b),e&&c.push(e),b+=1}),c},a.prototype.filter=function(a,b){var c,d,e,f,g=this;d=this.filter_states();for(e=0,f=d.length;e<f;e++)c=d[e],c.tokens=this.search.parseSearchTokens(c.value);return d&&d.length>0&&(a=a.filter(function(a){var b,c,e,f,h;b=d3.values(a),e=!0;for(f=0,h=d.length;f<h;f++){c=d[f];if(!g.search.doesTextMatchTokens(b[c.idx],c.tokens,!1)){e=!1;break}}return e})),a},a.prototype.limit=function(a,b){var c,d,e,f;return f=Math.ceil(a.length/b.limit),c=Math.max(b.page,0),c=Math.min(c,f),e=(c-1)*b.limit,d=Math.min(c*b.limit,a.length)-1,a.slice(e,d+1||9e9)},a.prototype.header=function(a){return d3.keys(a[0])},a.prototype.show=function(a,b){var c;return this.original_data=b,d3.select("#"+a).html('<div id="data_grid_pagination_top"></div><div id="data_grid_data"></div><div id="data_grid_pagination_bottom"></div>'),c=this.get_options(),this.create_view("#data_grid_data",b,c),this.refresh()},a.prototype.refresh=function(){var a,b,c;return b=this.get_options(),a=this.original_data,this.filtered_data=this.filter(a,b),this.sort(this.filtered_data,b),b.page_top&&this.create_view_pagination("#data_grid_pagination_top",this.filtered_data,b),b.page_bottom&&this.create_view_pagination("#data_grid_pagination_bottom",this.filtered_data,b),c=this.limit(this.filtered_data,b),this.refresh_view(c,b)},a.prototype.start_refresh_timer=function(){return this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.end_refresh_timer,this.get_options().timer_interval)},a.prototype.end_refresh_timer=function(){return this.timer=null,this.refresh()},a}(),a.DataGrid=e})).call(this);